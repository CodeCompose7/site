{{ define "main" }}
  {{- /* draft 페이지는 접근 불가 - 단일 글의 draft만 체크 */}}
  {{- $isDraft := false }}
  
  {{- /* .Draft 속성 체크 */}}
  {{- if .Draft }}
    {{- $isDraft = true }}
  {{- end }}
  
  {{- /* .Params.draft 체크 */}}
  {{- if not $isDraft }}
    {{- if eq .Params.draft true }}
      {{- $isDraft = true }}
    {{- else if .Params.draft }}
      {{- $isDraft = true }}
    {{- end }}
  {{- end }}
  
  {{- /* buildDrafts가 false이고 draft인 경우에만 차단 */}}
  {{- if and $isDraft (not .Site.BuildDrafts) }}
    {{- /* 404 페이지 표시 */}}
    <h1 class="mb-3 text-4xl font-extrabold">페이지를 찾을 수 없습니다</h1>
    <p class="mb-12 mt-8 text-neutral-400 dark:text-neutral-500">
      Error 404
    </p>
    <div class="prose dark:prose-invert">
      <p>요청하신 페이지가 존재하지 않습니다.</p>
      <p class="text-sm text-neutral-500">이 페이지는 draft 상태입니다.</p>
    </div>
  {{- else }}
  {{- /* draft가 아니거나 buildDrafts가 true인 경우 정상 렌더링 */}}
    {{- $images := .Resources.ByType "image" }}
  {{- $cover := $images.GetMatch (.Params.cover | default "*cover*") }}
  {{- $feature := $images.GetMatch (.Params.feature | default "*feature*") | default $cover }}
  {{- $showToc := and (.Params.showTableOfContents | default (.Site.Params.article.showTableOfContents | default false)) (in .TableOfContents "<ul") }}
  <article>
    <header>
      {{ if .Params.showBreadcrumbs | default (.Site.Params.article.showBreadcrumbs | default false) }}
        {{ partial "breadcrumbs.html" . }}
      {{ end }}
      <h1 class="mb-2 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        {{ .Title | emojify }}
      </h1>
      {{ if or
        (.Params.showDate | default (.Site.Params.article.showDate | default true))
        (and (.Params.showDateUpdated | default (.Site.Params.article.showDateUpdated | default false)) (ne (partial "functions/date.html" .Date) (partial "functions/date.html" .Lastmod)))
        (and (.Params.showWordCount | default (.Site.Params.article.showWordCount | default false)) (ne .WordCount 0))
        (and (.Params.showReadingTime | default (.Site.Params.article.showReadingTime | default true)) (ne .ReadingTime 0))
        (.Params.showEdit | default (.Site.Params.article.showEdit | default false))
      }}
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          <div class="flex flex-col">
            <div class="single-article-meta">
              {{ partial "article-meta.html" (dict "context" . "scope" "single") }}
            </div>
            <div class="single-difficulty mt-3">
              {{- $level := .Params.level | default 0 -}}
              {{- $hours := .Params.hours | default "" -}}
              {{- $hasDifficulty := and (ge $level 1) (le $level 5) -}}
              {{- $hasDuration := ne $hours "" -}}
              <ul class="single-difficulty-list ps-5 space-y-0.5 text-base font-light text-neutral-600 dark:text-neutral-300">
                {{- if $hasDifficulty }}
                  {{ partial "difficulty-level.html" . }}
                {{- end }}
                {{- if $hasDuration }}
                  {{ partial "course-duration.html" . }}
                {{- end }}
                {{- if or $hasDifficulty $hasDuration }}
                  {{ partial "course-meta-separator.html" . }}
                {{- end }}
                {{ partial "course-version-meta.html" . }}
              </ul>
            </div>
          </div>
        </div>
      {{ end }}
      {{ with $feature }}
        <div class="prose">
          {{ $altText := $.Params.featureAlt | default $.Params.coverAlt | default "" }}
          {{ $class := "mb-6 rounded-md" }}
          {{ $webp := $.Page.Site.Params.enableImageWebp | default true }}
          {{ partial "picture.html" (dict "img" . "alt" $altText "class" $class "lazy" false "webp" $webp) }}
          {{ with $.Params.coverCaption }}
            <figcaption class="-mt-3 mb-6 text-center">{{ . | markdownify }}</figcaption>
          {{ end }}
        </div>
      {{ end }}
    </header>

    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      {{ if $showToc }}
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8 single-toc-col" data-toc-col>
          <div class="toc pe-5 lg:sticky lg:top-10 print:hidden">
            <div class="mb-4 flex justify-end">
              <button
                type="button"
                class="items-center justify-center rounded-md border border-neutral-200 bg-neutral-50 px-0 text-xs font-medium text-neutral-600 shadow-sm hover:bg-neutral-100 dark:border-neutral-700 dark:bg-neutral-800 dark:text-neutral-200"
                data-toc-toggle
                data-toc-state="visible"
              >
                <span class="sr-only" data-toc-label>목차 숨기기</span>
                <span aria-hidden="true" data-toc-icon>▶</span>
              </button>
            </div>
            <div data-toc-panel>
              {{ partial "toc.html" . }}
            </div>
          </div>
        </div>
      {{ end }}
      <div class="min-h-0 min-w-0 grow">
        {{ .Content | emojify }}
      </div>
    </section>
    <footer class="pt-8 print:hidden">
      {{ partial "author.html" . }}
      {{ partial "sharing-links.html" . }}
      {{ partial "article-pagination.html" . }}
      {{ if .Params.showComments | default (.Site.Params.article.showComments | default false) }}
        {{ if templates.Exists "_partials/comments.html" }}
          <div class="pt-3">
            <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
            <div class="pt-3">
              {{ partial "comments.html" . }}
            </div>
          </div>
        {{ else }}
          {{ warnf "[CONGO] Comments are enabled for %s but no comments partial exists." .File.Path }}
        {{ end }}
      {{ end }}
    </footer>

    {{- /* 데스크톱(1280px 이상)에서 목차 토글 버튼으로 TOC 패널을 숨기고/보이게 제어하는 스크립트 */}}
    {{- if $showToc }}
      <script>
        (function () {
          if (typeof window === 'undefined') return;

          var toggleBtn = document.querySelector('[data-toc-toggle]');
          var tocCol = document.querySelector('[data-toc-col]');
          if (!toggleBtn || !tocCol) return;

          // 세션 스토리지 키 (모든 문서에서 공유)
          var STORAGE_KEY = 'toc-collapsed';

          // 세션 스토리지에서 초기 상태 읽기 (기본값: false)
          function getTocState() {
            try {
              var stored = sessionStorage.getItem(STORAGE_KEY);
              return stored === 'true';
            } catch (e) {
              return false;
            }
          }

          // 세션 스토리지에 상태 저장
          function saveTocState(collapsed) {
            try {
              sessionStorage.setItem(STORAGE_KEY, collapsed ? 'true' : 'false');
            } catch (e) {
              // 스토리지 사용 불가 시 무시
            }
          }

          // 목차 접힘 상태를 세션 스토리지에서 읽어옴
          var tocCollapsed = getTocState();

          function applyState() {
            if (window.innerWidth >= 1280) {
              if (tocCollapsed) {
                tocCol.classList.add('toc-collapsed');
              } else {
                tocCol.classList.remove('toc-collapsed');
              }
            } else {
              // 모바일/태블릿에서는 항상 펼쳐진 상태 유지
              tocCol.classList.remove('toc-collapsed');
            }
          }

          function updateLabel() {
            var isCollapsed = tocCollapsed && window.innerWidth >= 1280;
            var label = isCollapsed ? '목차 보이기' : '목차 숨기기';

            toggleBtn.setAttribute('data-toc-state', isCollapsed ? 'hidden' : 'visible');
            toggleBtn.setAttribute('aria-label', label);
            toggleBtn.setAttribute('title', label);

            var labelSpan = toggleBtn.querySelector('[data-toc-label]');
            if (labelSpan) {
              labelSpan.textContent = label;
            }
          }

          function handleClick() {
            if (window.innerWidth < 1280) {
              return; // 모바일/태블릿에서는 기존 세로형 TOC 동작 유지
            }
            tocCollapsed = !tocCollapsed;
            saveTocState(tocCollapsed); // 세션 스토리지에 저장
            applyState();
            updateLabel();
          }

          toggleBtn.addEventListener('click', handleClick);

          // 초기 상태/라벨 설정
          applyState();
          updateLabel();

          // 리사이즈 시 해상도에 맞게 상태를 다시 적용
          window.addEventListener('resize', function () {
            applyState();
            updateLabel();
          });
        })();
      </script>
    {{- end }}
  </article>
  {{- end }}
{{ end }}

