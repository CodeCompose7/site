{{ define "main" }}
  {{ $toc := and (.Params.showTableOfContents | default (.Site.Params.list.showTableOfContents | default false)) (in .TableOfContents "<ul") }}
  <header>
    {{ if .Params.showBreadcrumbs | default (.Site.Params.list.showBreadcrumbs | default false) }}
      {{ partial "breadcrumbs.html" . }}
    {{ end }}
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">{{ .Title }}</h1>
  </header>
  <section
    class="{{ if $toc -}}
      mt-12
    {{- else -}}
      mt-0
    {{- end }} prose flex max-w-full flex-col dark:prose-invert lg:flex-row"
  >
    {{ if $toc }}
      <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
        <div class="toc ps-5 lg:sticky lg:top-10">
          {{ partial "toc.html" . }}
        </div>
      </div>
    {{ end }}
    <div class="min-h-0 min-w-0 max-w-prose grow">
      {{ .Content | emojify }}
    </div>
  </section>
  
  {{- /* 카테고리명 추출 (폴더명에서) */}}
  {{- $categoryName := "" }}
  {{- if .File }}
    {{- $dirParts := split (strings.TrimSuffix "/" .File.Dir) "/" }}
    {{- /* blog/categories/paper-review/ -> paper-review */}}
    {{- $categoryName = index $dirParts (sub (len $dirParts) 1) }}
  {{- else }}
    {{- /* 폴더명을 직접 추출 */}}
    {{- $pathParts := split (strings.TrimPrefix "/" (strings.TrimSuffix "/" .RelPermalink)) "/" }}
    {{- /* ko/blog/categories/paper-review -> paper-review */}}
    {{- if ge (len $pathParts) 4 }}
      {{- $categoryName = index $pathParts 3 }}
    {{- end }}
  {{- end }}
  {{- /* 섹션 루트는 helper로 해결: front matter(sectionKey/categorySection) 우선 */}}
  {{- $sectionArg := .Params.categorySection | default (.Params.sectionKey | default "") }}
  {{- $resolved := partial "functions/section-root.html" (dict "context" . "section" $sectionArg) }}
  {{- $blogSection := $resolved.page }}
  {{- $blogSectionName := $resolved.name }}
  {{- $allPosts := slice }}
  {{- if $blogSection }}
    {{- /* blog 섹션 전체(하위 폴더 포함)를 대상으로 카테고리 필터링 */}}
    {{- $allPosts = $blogSection.RegularPagesRecursive }}
  {{- end }}
  {{- /* buildDrafts가 false인 경우에만 draft 필터링 */}}
  {{- if not .Site.BuildDrafts }}
    {{- $allPosts = where $allPosts "Draft" "!=" true }}
  {{- end }}
  {{- $filteredPosts := where $allPosts "Params.categories" "intersect" (slice $categoryName) }}
  
  <section>
    {{- /* 카테고리 필터는 항상 표시 */}}
    {{ partial "category-filter.html" (dict "context" . "currentCategory" $categoryName "blogSection" $blogSection "section" "blog") }}
  
  {{ if $filteredPosts }}
      
      {{- /* 카테고리 term 페이지인 경우 sidebar 이미지/텍스트 표시 */}}
      {{- $sidebarImage := .Params.sidebarImage | default "" }}
      {{- $sidebarText := .Params.sidebarText | default "" }}
      {{- $pagerSize := .Params.pagerSize | default (.Site.Params.pagination.pagerSize | default 10) }}
      {{- $paginator := .Paginate $filteredPosts $pagerSize }}
      
      {{- if or $sidebarImage $sidebarText }}
        {{- /* sidebar가 있는 경우 list-sidebar-wrapper 사용 */}}
        {{ partial "list-sidebar-wrapper.html" (dict "context" . "pages" $paginator.Pages) }}
      {{- else }}
        {{- /* sidebar가 없는 경우 article-card 레이아웃 사용 */}}
        <div class="grid min-h-[1200px] grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 blog-grid">
          {{ range $paginator.Pages }}
            {{ partial "article-card.html" . }}
          {{ end }}
        </div>
      {{- end }}
    {{ partial "pagination.html" . }}
  {{ else }}
    <section class="prose mt-10 dark:prose-invert">
      <p class="border-t py-8">
        <em>{{ i18n "list.no_articles" | emojify }}</em>
      </p>
    </section>
  {{ end }}
  </section>
{{ end }}


